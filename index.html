<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Drive „Éï„Ç©„Éà„Ç¢„É´„Éê„É†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }
        .container {
            text-align: center;
            max-width: 1200px;
            width: 90%;
            padding: 20px;
        }
        h1 {
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        button {
            background: white;
            color: #667eea;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #pauseButton {
            background: #ff6b6b;
            color: white;
        }
        .settings {
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .settings label {
            font-size: 16px;
        }
        .settings input {
            padding: 8px 15px;
            font-size: 16px;
            border: none;
            border-radius: 25px;
            width: 80px;
            text-align: center;
        }
        #imageContainer {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            margin: 20px 0;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #currentImage {
            max-width: 100%;
            max-height: 90vh;
            border-radius: 10px;
            display: none;
        }
        #status {
            margin: 20px 0;
            font-size: 18px;
            min-height: 30px;
        }
        .hidden {
            display: none;
        }
        #imageInfo {
            color: #333;
            margin-top: 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì∏ Google Drive „Éï„Ç©„Éà„Ç¢„É´„Éê„É†</h1>
        
        <div id="status">ÂàùÊúüÂåñ‰∏≠...</div>
        
        <div id="authSection">
            <button id="authButton" disabled>Google „Åß„É≠„Ç∞„Ç§„É≥</button>
        </div>
        
        <div id="folderSection" class="hidden">
            <button id="selectFolderButton">„Éï„Ç©„É´„ÉÄ„ÇíÈÅ∏Êäû</button>
        </div>
        
        <div id="controls" class="hidden">
            <div class="settings">
                <label for="intervalInput">Ë°®Á§∫ÈñìÈöî:</label>
                <input type="number" id="intervalInput" min="1" max="60" value="5">
                <label>Áßí</label>
            </div>
            <button id="startButton">„Çπ„É©„Ç§„Éâ„Ç∑„Éß„ÉºÈñãÂßã</button>
            <button id="pauseButton" class="hidden">‰∏ÄÊôÇÂÅúÊ≠¢</button>
            <button id="nextButton" class="hidden">Ê¨°„ÅÆÁîªÂÉè</button>
        </div>
        
        <div id="imageContainer" class="hidden">
            <img id="currentImage" alt="Photo">
            <div id="imageInfo"></div>
        </div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script>
        // „Åì„Åì„Å´„ÅÇ„Å™„Åü„ÅÆ„ÇØ„É©„Ç§„Ç¢„É≥„ÉàID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ
        const CLIENT_ID = '625890919803-er1k7avgmsrbpu6qk9e7t0dnedrlcs12.apps.googleusercontent.com';
        // Google Picker API„Ç≠„ÉºÔºàÂêå„Åò„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅßÂèñÂæóÔºâ
        const API_KEY = 'AIzaSyDiEinI5bMSkBeahQikOusHt2U8erspktQ';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        
        let tokenClient;
        let accessToken = null;
        let pickerInited = false;
        let gisInited = false;
        let selectedFolderId = null;
        let imageFiles = [];
        let currentImageIndex = 0;
        let isPaused = false;
        let slideshowInterval = null;
        let intervalSeconds = 5;

        // GAPIÂàùÊúüÂåñ
        function gapiLoaded() {
            gapi.load('client:picker', initializePicker);
        }

        async function initializePicker() {
            await gapi.client.load('https://www.googleapis.com/discovery/v1/apis/drive/v3/rest');
            pickerInited = true;
            maybeEnableButtons();
        }

        // GISÂàùÊúüÂåñ
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // Âæå„ÅßË®≠ÂÆö
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (pickerInited && gisInited) {
                document.getElementById('authButton').disabled = false;
                document.getElementById('status').textContent = 'Google „Ç¢„Ç´„Ç¶„É≥„Éà„Åß„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
            }
        }

        // Ë™çË®º„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ
        document.getElementById('authButton').addEventListener('click', handleAuthClick);

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    document.getElementById('status').textContent = '„Ç®„É©„Éº: ' + resp.error;
                    throw (resp);
                }
                accessToken = resp.access_token;
                gapi.client.setToken({access_token: accessToken});
                onAuthSuccess();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        function onAuthSuccess() {
            document.getElementById('status').textContent = 'Ë™çË®ºÊàêÂäüÔºÅÁîªÂÉè„ÅåÂÖ•„Å£„Åü„Éï„Ç©„É´„ÉÄ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('folderSection').classList.remove('hidden');
        }

        // „Éï„Ç©„É´„ÉÄÈÅ∏Êäû„Éú„Çø„É≥
        document.getElementById('selectFolderButton').addEventListener('click', showPicker);

        function showPicker() {
            const picker = new google.picker.PickerBuilder()
                .addView(google.picker.ViewId.FOLDERS)
                .setOAuthToken(accessToken)
                .setDeveloperKey(API_KEY)
                .setCallback(pickerCallback)
                .build();
            picker.setVisible(true);
        }

        async function pickerCallback(data) {
            if (data.action === google.picker.Action.PICKED) {
                selectedFolderId = data.docs[0].id;
                document.getElementById('status').textContent = 'ÁîªÂÉè„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô...';
                await loadImages();
                
                if (imageFiles.length > 0) {
                    document.getElementById('folderSection').classList.add('hidden');
                    document.getElementById('controls').classList.remove('hidden');
                    document.getElementById('imageContainer').classList.remove('hidden');
                    document.getElementById('status').textContent = `${imageFiles.length}Êûö„ÅÆÁîªÂÉè„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„Åü`;
                } else {
                    document.getElementById('status').textContent = '„Åì„ÅÆ„Éï„Ç©„É´„ÉÄ„Å´ÁîªÂÉè„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü';
                }
            }
        }

        async function loadImages() {
            try {
                const response = await gapi.client.drive.files.list({
                    'q': `'${selectedFolderId}' in parents and mimeType contains 'image/' and trashed=false`,
                    'fields': 'files(id, name, mimeType)',
                    'pageSize': 1000
                });
                
                imageFiles = response.result.files || [];
                shuffleArray(imageFiles);
                console.log(`${imageFiles.length}Êûö„ÅÆÁîªÂÉè„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü`);
            } catch (error) {
                console.error('Error loading images:', error);
                document.getElementById('status').textContent = '„Ç®„É©„Éº: ÁîªÂÉè„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        async function displayImage(index) {
            if (imageFiles.length === 0) return;
            
            const file = imageFiles[index];
            const img = document.getElementById('currentImage');
            const info = document.getElementById('imageInfo');
            
            try {
                const token = gapi.client.getToken();
                
                if (!token) {
                    info.textContent = '„Çª„ÉÉ„Ç∑„Éß„É≥„ÅåÂàá„Çå„Åæ„Åó„Åü„ÄÇ„Éö„Éº„Ç∏„Çí„É™„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                    if (slideshowInterval) {
                        clearInterval(slideshowInterval);
                    }
                    return;
                }
                
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`,
                    {
                        headers: {
                            'Authorization': `Bearer ${token.access_token}`
                        }
                    }
                );
                
                if (response.status === 401) {
                    info.textContent = '„Çª„ÉÉ„Ç∑„Éß„É≥„ÅåÂàá„Çå„Åæ„Åó„Åü„ÄÇ„Éö„Éº„Ç∏„Çí„É™„É≠„Éº„Éâ„Åó„Å¶ÂÜç„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                    if (slideshowInterval) {
                        clearInterval(slideshowInterval);
                    }
                    document.getElementById('status').textContent = '‚ö†Ô∏è „Çª„ÉÉ„Ç∑„Éß„É≥„ÅåÂàá„Çå„Åæ„Åó„Åü„ÄÇ„Éö„Éº„Ç∏„Çí„É™„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                    return;
                }
                
                const blob = await response.blob();
                const imageUrl = URL.createObjectURL(blob);
                
                img.onload = () => {
                    img.style.display = 'block';
                };
                img.src = imageUrl;
                info.textContent = file.name;
                
            } catch (error) {
                console.error('Error displaying image:', error);
                info.textContent = 'ÁîªÂÉè„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + file.name;
            }
        }

        document.getElementById('startButton').addEventListener('click', () => {
            if (imageFiles.length === 0) return;
            
            intervalSeconds = parseInt(document.getElementById('intervalInput').value) || 5;
            
            isPaused = false;
            document.getElementById('startButton').classList.add('hidden');
            document.getElementById('pauseButton').classList.remove('hidden');
            document.getElementById('nextButton').classList.remove('hidden');
            document.getElementById('intervalInput').disabled = true;
            
            currentImageIndex = 0;
            displayImage(currentImageIndex);
            
            slideshowInterval = setInterval(() => {
                if (!isPaused) {
                    currentImageIndex = (currentImageIndex + 1) % imageFiles.length;
                    displayImage(currentImageIndex);
                }
            }, intervalSeconds * 1000);
        });

        document.getElementById('pauseButton').addEventListener('click', () => {
            isPaused = !isPaused;
            const pauseBtn = document.getElementById('pauseButton');
            if (isPaused) {
                pauseBtn.textContent = 'ÂÜçÁîü';
                pauseBtn.style.background = '#51cf66';
            } else {
                pauseBtn.textContent = '‰∏ÄÊôÇÂÅúÊ≠¢';
                pauseBtn.style.background = '#ff6b6b';
            }
        });

        document.getElementById('nextButton').addEventListener('click', () => {
            currentImageIndex = (currentImageIndex + 1) % imageFiles.length;
            displayImage(currentImageIndex);
            
            if (slideshowInterval) {
                clearInterval(slideshowInterval);
                slideshowInterval = setInterval(() => {
                    if (!isPaused) {
                        currentImageIndex = (currentImageIndex + 1) % imageFiles.length;
                        displayImage(currentImageIndex);
                    }
                }, intervalSeconds * 1000);
            }
        });

        // ÂàùÊúüÂåñ„ÉÅ„Çß„ÉÉ„ÇØ
        window.onload = () => {
            if (CLIENT_ID === 'YOUR_CLIENT_ID' || API_KEY === 'YOUR_API_KEY') {
                document.getElementById('status').textContent = '‚ö†Ô∏è CLIENT_ID„Å®API_KEY„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
                document.getElementById('authButton').disabled = true;
            } else {
                gapiLoaded();
                gisLoaded();
            }
        };
    </script>
</body>
</html>